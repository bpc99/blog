---
title: Token登陆认证
date: 2021-03-18 18:23:21
subtitle: token
tags:
  - Token
categories: [Node]
---
由于`HTTP`是一种无状态的协议，也就是服务器单从网络连接上是无法认知用户身份的，那如果某些接口只能特定才能访问该怎么办呢？这就需要为登陆的用户发行一个通行证。这样服务器可以通过通行证来认证客户身份。

<!-- more -->

## Cookie/Session 认证方案
### Cookie
`cookie`是一种浏览器存储数据的一种方式，仅仅是为浏览器提供一种数据的存储功能。`cookie`存储的时间也可以在保存的时候设置，当然如果没有设置，那么只有浏览器关闭的时候会自动消失。
`cookie`存储的是一些字符串信息，在客户端进行登陆时，后台需要返回一个`Token`记录当前用户状态，客户端使用`cookie`将`Token`保存起来。当浏览器在请求该网站别的接口时，浏览器会将地址和`cookie`一同提交至服务器。服务器会解析该`cookie`，以确定登陆的用户。

**注意：**`cookie`功能仅是浏览器存储数据的功能，如果不是浏览器那么就需要考虑是否支持`cookie`了，如果不支持那么该功能便会失效。并且不同的浏览器保存的方式也不一样，`IE`和别的浏览器使用 `cookie` 的方式是不同的。

### Session
`Session`是另一种记录用户信息的机制，在客户端登陆后，返回客户端 **session_id** 存放到`cookie`中，这样在客户端请求时带上 **session_id** 就可以验证服务器端是否存在`session`数据，以此完成用户认证。
这种认证方式，可以更好的在服务端对会话进行控制，安全性比较高(**session_id** 随机），但是服务端需要存储`session`数据(如内存或数据库），这样无疑增加维护成本和减弱可扩展性(多台服务器)。 
但是`session`有一个致命的**缺陷**：因为此方式对服务器压力过大，所以有时需要负载均衡，那么转发到另一个服务器时`session`会丢失。

**提示：**`Session`不管方便性还是安全性都优于`Cookie`，但是过多的`session`会存储在服务器内存中，这样会对服务器造成很大的压力。

### Cookie 与 Session 的区别和联系
1. `cookie`数据存放到客户浏览器上，`Session`数据保存到服务器上。
2. `cookie`存储并不安全，可以进行多种方式来欺骗服务器，而`Session`返回的为 **session_id** 更加的安全。
3. `session`会占用大量服务器内存，一旦访问量增加，会比较占用服务器性能。如要考虑服务器性能，请考虑`Cookie`。
4. `cookie`在浏览器中的限制为 3k，如果一个站点存储信息不能超过 3k。

但是虽然上面又很多不同，但是就算是`Session`方式，也需要`cookie`的配合，因为服务端会返回 **session_id** 给客户端，客户端每次请求都会把这个 id 值放到 http请求 的头部发送给服务端，而这个 id 值在客户端会保存下来，保存的容器就是 cookie，因此当我们完全禁掉浏览器的 cookie 的时候，服务端的 session 也会不能正常使用。

## 基于 Token 的身份验证
基于 Token 验证身份是 **无状态** 的，我们 **不将** 用户相关信息存储到服务器中。这就解决了一些服务器 session 丢失的问题。也意味着我们可以根据自己需求增删服务器，而不用担心用户是否登陆。
### 基本流程
1. 用户通过账户名和密码发送请求进行登陆。
2. 服务器对用户验证。
3. 服务器返回一个 **带签名** 的 `token` 给客户端。
4. 客户端通过 cookie 存储`token`，并且每次请求`API`都会自动带上`Token`发送到服务器。
5. 服务器验证`Token`，成功返回数据，否则返回 401。

![](https://img.bipch.cn/2021/03/19/ddce3c7588e15.png)

第一次绘制这种流程图，有些水印，后续考虑更换软件。

### 优势
1. **无状态、可扩展**
因为客户端存储的`Token`是无状态的，并且能够被扩展。基于这种无状态和不存储`Session`信息，负载负载均衡器能够将用户信息从一个服务传到其他服务器上。这样只使用`Token`便能直接完成用户验证了。
2. **安全性**
因为`Token`是具有时效性的，一段时间之后必须重新验证，并且`Token`的解析必须由指定密匙才能解析出真正的数据。
3. **可扩展性 和 跨平台性**
`Tokens`允许任意的平台使用，因为其只是一个加密字符串。

### 项目中使用 Token
项目开发中还是很常用该方式的，其**不用再**服务器记录用户信息。大致流程如下：
1. 前端用户第一次登陆或退出后在进行登陆。
2. 后台验证前端传入的数据是否正确。
3. 验证成功后，根据用户 ID、秘钥、过期时间生成一个特殊字符串(Token)。然后将`Token`返回给前端。
4. 前端接收到`Token`，进行存储，存储地方可以为`cookie`、`H5 WebStorage`。
5. 界面每次跳转都进行判断是否具有`Token`，有则获取用户详细信息，没有重定向至登陆页(导航守卫)。
6. 编写服务器端中间件，验证是否有`Token`，有则解析`Token`并将用户保存调用`next`，否则返回404。